<html>
<!-- https://stackoverflow.com/a/25836471 -->
<head>

<meta charset="UTF-8">
<link rel="stylesheet" href="flo.css">
<script>
/*        var options = ['ul','div'];
        var subOptions = {
            'ul':['li'],
            'div':['div','span', 'p']
        };*/
</script>

<script>

var lastCorrect = new Array();

function unhighlight(x, i) {
  x.style.backgroundColor="transparent";
  var summary = document.getElementById('details_'+i.toString());
  summary.open = false;
}

function highlight(x, i) {
  x.style.backgroundColor="red";
  var summary = document.getElementById('details_'+i.toString());
  summary.open = true;
}

function controlloTesto(mytextarea) {
  var corrections;
  //Please wait
  //document.getElementById('corrections').innerHTML = '<img src="wait.gif">';

  var xmlhttp = new XMLHttpRequest();
  if (window.XMLHttpRequest) {
      xmlhttp = new XMLHttpRequest();
      if (xmlhttp.overrideMimeType) {
    	xmlhttp.overrideMimeType('text/plain');
      }
  } else if (window.ActiveXObject) {
      // IE
      try { xmlhttp = new ActiveXObject("Msxml2.XMLHTTP"); }
      catch (e) {
	try { xmlhttp = new ActiveXObject("Microsoft.XMLHTTP"); }
	catch (e) {}
      }
  }

  if (!xmlhttp) {
      alert('Cannot create an XMLHTTP instance');
  }

  var mytext = document.getElementById(mytextarea).innerHTML; //.innerText.replace(/<[^>]+>/g, '');
  var apipage = window.location.origin +"/floapi";
  var data = new FormData();
  data.append('text', mytext);
  xmlhttp.open("POST", apipage, true);
  xmlhttp.send(data);
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == XMLHttpRequest.DONE) {
	var correct = JSON.parse(xmlhttp.responseText);
	//console.log(correct);
	lastCorrect = correct;
        corrections = correct["original"];
        for (var i = correct["corrections"].length -1; i > -1; i--) {
    	  corrections = corrections.substring(0,correct["corrections"][i]["start"])+"<span id=\"correction_"+i.toString()+"\" class=\"correctionSpan\" data-tooltip=\""+correct["corrections"][i]["recommendedText"]+"\" data-tooltip-position=\"bottom\" onmouseover=\"highlight(this,"+i.toString()+")\" onmouseout=\"unhighlight(this,"+i.toString()+")\">"+corrections.substring(correct["corrections"][i]["start"],correct["corrections"][i]["end"])+"</span>"+corrections.substring(correct["corrections"][i]["end"], corrections.length);
    	}
	mytexteditor = document.getElementById(mytextarea);
	mytexteditor.innerHTML = corrections;
        fillCorrectionsList();
    }
  }

  
}

function checkTextEditor() {
 mytexteditor = document.getElementById("textEditor");
 originaltext = mytexteditor.innerHTML;
 var corrections = "";
 
 controlloTesto("textEditor");
 
}

function fillCorrectionsList() {
  mycorrlist = document.getElementById("correctionsList");
  var tmpcorrlist = "<h1>Correzioni</h1>";
  try {
    for (var i = 0; i < lastCorrect["corrections"].length; i++) {
      tmpcorrlist += "<details id=\"details_"+i.toString()+"\">";
      tmpcorrlist += "<summary id=\"summary_"+i.toString()+"\"><p>Correzione "+i.toString()+"</p></summary>";
      tmpcorrlist += "<p><span id=\"explaination_"+i.toString()+"\" onclick=\"highlight(correction_"+i.toString()+", "+i.toString()+")\">"+lastCorrect["corrections"][i]["explanation"]+"</p></span>";
      tmpcorrlist += "</details>";
      document.getElementById("correction_"+i.toString()).style.textDecoration = "underline double red";
    }
  } catch (error) {
    //nothing
  }
  mycorrlist.innerHTML = tmpcorrlist;
}

window.onload = function () {
  fillCorrectionsList();
}
</script>
</head>
<body>
<table> 
<tr>
<td id="editorSection">
    <h1>Facile da Leggere Online</h1>
    <div id="textEditor" contenteditable="true">
Dal 7 al 15 gennaio 2021 è vietato, nell'ambito del territorio nazionale, ogni spostamento in entrata e in uscita tra i territori di diverse regioni o province autonome, salvi gli spostamenti motivati da comprovate esigenze lavorative o situazioni di necessità ovvero per motivi di salute. </br>
Il Rem non e' compatibile con la presenza nel nucleo familiare di componenti che percepiscono o hanno percepito una delle indennità di cui agli articoli 27, 28, 29, 30 e 38 del decreto-legge  17 marzo 2020, n. 18, convertito, con modificazioni, dalla legge 24 aprile 2020, n. 27, ovvero di una delle indennità disciplinate in attuazione dell'articolo 44 del medesimo decreto-legge ovvero di una delle indennità di cui agli articoli 84 e 85 del presente decreto-legge. Il Rem non è altresì compatibile con la presenza nel nucleo familiare di componenti che siano al momento della domanda in una delle seguenti condizioni:
</br> 
 a) essere titolari di pensione diretta o indiretta ad eccezione dell'assegno ordinario di invalidità;
</br>
 b) essere titolari di un rapporto di lavoro dipendente la cui retribuzione lorda sia superiore agli importi di cui al comma 5;     
    </div>
    </br>
    <button id="submitButton" onclick="checkTextEditor();">Controlla</button>
</td>
<td id="correctionsSection" rowspan="3">
    <div id="correctionsList">
    </div>    
</td>
</tr>
</table>
</body>
</html>
