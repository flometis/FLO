<html>
<!-- https://stackoverflow.com/a/25836471 -->
<head>

<meta charset="UTF-8">
<link rel="stylesheet" href="flo.css">
<script>
/*        var options = ['ul','div'];
        var subOptions = {
            'ul':['li'],
            'div':['div','span', 'p']
        };*/
</script>

<script>

var lastCorrect = new Array();

var vdb2016 = new Array();

function getSelectorStyle(selector) { 
    for(var i = 0; i < document.styleSheets.length; i++) {
        var rules = document.styleSheets[i].rules || document.styleSheets[i].cssRules;
        for(var x in rules) {
            if(typeof rules[x].selectorText == 'string') {
              if(rules[x].selectorText == selector) {
                return document.styleSheets[i].cssRules[x].style;
              }
            }
        }
    }
}

function unhighlight(x, i) {
  x.style.cssText = getSelectorStyle("."+x.className).cssText;
  var summary = document.getElementById('details_'+i.toString());
  summary.open = false;
}

function highlight(x, i) {
  x.style.cssText = getSelectorStyle(".correction_highlighted").cssText;
  if (x.style.cssText=="") x.style.backgroundColor="red";
  var summary = document.getElementById('details_'+i.toString());
  summary.open = true;
}

function recommendSynonims(allSynonims) {
  var synonims = "";
  for (var l = 0; l< vdb2016.length; l++) {
    var lemma = vdb2016[l];
    if (allSynonims.includes(lemma) && lemma != "") {
      if (synonims != "") synonims = synonims + ", ";
      synonims = synonims + lemma;
    }
  }
  return synonims;
}

function controlloTesto(mytextarea) {
  var corrections;
  //Please wait
  document.getElementById('correctionsList').innerHTML = '<center><img src="flo-processing.gif" width="50%"></center>';

  var xmlhttp = new XMLHttpRequest();
  if (window.XMLHttpRequest) {
      xmlhttp = new XMLHttpRequest();
      if (xmlhttp.overrideMimeType) {
    	xmlhttp.overrideMimeType('text/plain');
      }
  } else if (window.ActiveXObject) {
      // IE
      try { xmlhttp = new ActiveXObject("Msxml2.XMLHTTP"); }
      catch (e) {
	try { xmlhttp = new ActiveXObject("Microsoft.XMLHTTP"); }
	catch (e) {}
      }
  }

  if (!xmlhttp) {
      alert('Cannot create an XMLHTTP instance');
  }

  var mytext = document.getElementById(mytextarea).innerHTML; //.innerText.replace(/<[^>]+>/g, '');
  mytext = mytext.replace(/\r\n|\r|\n/g, '<br>');
  //console.log(mytext);
  var apipage = window.location.origin +"/floapi";
  var data = new FormData();
  data.append('text', mytext);
  var myRS = "plain";
  var tmpRS = document.getElementById("ruleset").value;
  if ( tmpRS == "etr") myRS = "etr";
  data.append('ruleset', myRS);
  xmlhttp.open("POST", apipage, true);
  xmlhttp.send(data);
  xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == XMLHttpRequest.DONE) {
        try {
	  var correct = JSON.parse(xmlhttp.responseText);
        } catch (error) {
	  console.log(error);
          document.getElementById('correctionsList').innerHTML = '<center><h1>Errore, impossibile calcolare le correzioni</h1></center>';
        }
	lastCorrect = correct;
        corrections = correct["original"];
        for (var i = correct["corrections"].length -1; i > -1; i--) {
          recommend = correct["corrections"][i]["recommendedText"];
	  if ("synonims" in correct["corrections"][i]) {
            var synonims = recommendSynonims(correct["corrections"][i]["synonims"]);
            if (synonims == "") synonims = "una parola più semplice";
            recommend = recommend + synonims;
	  }
	  explain = lastCorrect["corrections"][i]["explanation"];
	  if (recommend == "") recommend = explain;
    	  var corrOrigText = corrections.substring(correct["corrections"][i]["start"],correct["corrections"][i]["end"]);

         if (! "category" in correct["corrections"][i]) correct["corrections"][i]["category"] = "generic";
         if ( correct["corrections"][i]["category"] == "lunghezza" ) {
           corrOrigText = "&#9986;";
         }

         corrections = corrections.substring(0,correct["corrections"][i]["start"])+"<span id=\"correction_"+i.toString()+"\" class=\"correctionSpan_"+correct["corrections"][i]["category"]+"\" data-tooltip=\""+recommend.replace(/\r\n|\r|\n/g, '')+"\" data-tooltip-position=\"bottom\" onmouseover=\"highlight(this,"+i.toString()+")\" onmouseout=\"unhighlight(this,"+i.toString()+")\">"+corrOrigText+"</span>"+corrections.substring(correct["corrections"][i]["end"], corrections.length);
    	}
	mytexteditor = document.getElementById(mytextarea);
	mytexteditor.innerHTML = corrections;
        fillCorrectionsList();
    }
  }

  
}


function checkTextEditor() {
 mytexteditor = document.getElementById("textEditor");
 originaltext = mytexteditor.innerHTML;
 var corrections = "";
 
 controlloTesto("textEditor");
 
}

function fillCorrectionsList() {
  mycorrlist = document.getElementById("correctionsList");
  var tmpcorrlist = "<h1>Correzioni</h1>";
  try {
    for (var i = 0; i < lastCorrect["corrections"].length; i++) {
      tmpcorrlist += "<details id=\"details_"+i.toString()+"\">";
      tmpcorrlist += "<summary id=\"summary_"+i.toString()+"\"><p>Correzione "+i.toString()+"</p></summary>";
      var tmpthiscorr = "";
      tmpcorrlist += "<span id=\"explaination_"+i.toString()+"\" class=\"explainations\" onclick=\"highlight(correction_"+i.toString()+", "+i.toString()+")\"><p>"+lastCorrect["corrections"][i]["explanation"]+"</p></span>";
      tmpthiscorr += lastCorrect["corrections"][i]["explanation"];
      for (var n = 0; n < lastCorrect["correctionsNested"].length; n++) {
        if (lastCorrect["correctionsNested"][n]["start"]>lastCorrect["corrections"][i]["start"] && lastCorrect["correctionsNested"][n]["start"]<lastCorrect["corrections"][i]["end"]) {
          if (! tmpthiscorr.includes(lastCorrect["correctionsNested"][n]["explanation"])) {
            var synSuggestion = "";
            if ("synonims" in lastCorrect["correctionsNested"][n]) {
              var synonims = recommendSynonims(lastCorrect["correctionsNested"][n]["synonims"]);
              if (synonims == "") {
                synSuggestion =  "</br>Nessun sinonimo trovato nel Vocabolario di Base.";
              } else {
                synSuggestion = "</br>Sinonimi presenti nel Vocabolario di Base: "+ synonims;
              }
            }
            tmpcorrlist += "<span id=\"nested_"+n.toString()+"\" class=\"nested\" onclick=\"highlight(correction_"+i.toString()+", "+i.toString()+")\"><p>"+lastCorrect["correctionsNested"][n]["explanation"]+synSuggestion+"</p></span>";
            tmpthiscorr += lastCorrect["correctionsNested"][n]["explanation"];
          }
        }
      }
      tmpcorrlist += "</details>";
    }

    tmpcorrlist += "<h1>GulpEASE</h1>";
    tmpcorrlist += "<p>";
    for (var i = 1; i < lastCorrect["gulpease"].length; i++) {
      tmpcorrlist += "<b>"+lastCorrect["gulpease"][0][1]+"</b>: "+lastCorrect["gulpease"][i][1]+"</br>";
      tmpcorrlist += "<b>"+lastCorrect["gulpease"][0][2]+"</b>: "+lastCorrect["gulpease"][i][2]+"</br>";
      tmpcorrlist += "<b>"+lastCorrect["gulpease"][0][3]+"</b>: "+lastCorrect["gulpease"][i][3]+"</br>";
      tmpcorrlist += "<b>"+lastCorrect["gulpease"][0][4]+"</b>: "+lastCorrect["gulpease"][i][4]+"</br>";
    } 

    tmpcorrlist += "<h1>Misure Lessicometriche</h1>";
    tmpcorrlist += "<p>";
    for (var i = 1; i < lastCorrect["misure_lessicometriche"].length; i++) {
      tmpcorrlist += "<b>"+lastCorrect["misure_lessicometriche"][i][0]+"</b>: "+lastCorrect["misure_lessicometriche"][i][1]+"</br>";
    }
    tmpcorrlist += "</p>";
    tmpcorrlist += "<h1>Densità lessicale</h1>";
    tmpcorrlist += "<p>";
    for (var i = 2; i < lastCorrect["densita_lessicale"].length; i++) {
      tmpcorrlist += "<b>"+lastCorrect["densita_lessicale"][i][0]+"</b>: "+lastCorrect["densita_lessicale"][i][2]+"%</br>";
      if (i == 4) tmpcorrlist += "</br>";
    }
    tmpcorrlist += "</p>";

  } catch (error) {
    //nothing
  }
  

  mycorrlist.innerHTML = tmpcorrlist;
}

window.onload = function () {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
       vdb2016 = xhttp.responseText.replace(/\r/g,"").split("\n");
    }
  };
  xhttp.open("GET", "vdb2016.txt", true);
  xhttp.send();

  fillCorrectionsList();
}
</script>
</head>
<body>
<h1>Facile da Leggere Online</h1>
<p style="color: red; font-family: Courier New; font-style: bold;"> Attenzione: questa applicazione è una versione alpha, la maggioranza delle funzioni non è ancora implementata. Intanto, per saperne di più sulle linee guida, si può visitare la pagina <a href="https://faciledaleggere.online/lineeguida/">https://faciledaleggere.online/lineeguida/</a></br></p>
<table> 
<tr>
<td id="editorSection">
    <div id="textEditor" contenteditable="true">
Dal 7 al 15 gennaio 2021 è vietato, nell'ambito del territorio nazionale, ogni spostamento in entrata e in uscita tra i territori di diverse regioni o province autonome, salvi gli spostamenti motivati da comprovate esigenze lavorative o situazioni di necessità ovvero per motivi di salute. Si informano i cittadini che l’accesso agli uffici comunali è consentito esclusivamente previo appuntamento. </br>
Il Rem non e' compatibile con la presenza nel nucleo familiare di componenti che percepiscono o hanno percepito una delle indennità di cui agli articoli 27, 28, 29, 30 e 38 del decreto-legge  17 marzo 2020, n. 18, convertito, con modificazioni, dalla legge 24 aprile 2020, n. 27, ovvero di una delle indennità disciplinate in attuazione dell'articolo 44 del medesimo decreto-legge ovvero di una delle indennità di cui agli articoli 84 e 85 del presente decreto-legge. Il Rem non è altresì compatibile con la presenza nel nucleo familiare di componenti che siano al momento della domanda in una delle seguenti condizioni:
</br> 
 a) essere titolari di pensione diretta o indiretta ad eccezione dell'assegno ordinario di invalidità;
</br>
 b) essere titolari di un rapporto di lavoro dipendente la cui retribuzione lorda sia superiore agli importi di cui al comma 5;     
    </div>
    </br>
    Regole: <select id="ruleset"> <option value="plain">Plain Language</option> <option value="etr">Easy To Read</option> </select>
    </br>
    <button id="submitButton" onclick="checkTextEditor();">Controlla</button>
</td>
<td id="correctionsSection" rowspan="3">
    <div id="correctionsList">
    </div>    
</td>
</tr>
</table>
</body>
</html>
